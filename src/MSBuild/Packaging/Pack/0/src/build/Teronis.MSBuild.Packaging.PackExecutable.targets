<Project>

  <PropertyGroup>
    <TeronisMSBuildPackagingPackPackExecutableTargetsHasBeenImported>true</TeronisMSBuildPackagingPackPackExecutableTargetsHasBeenImported>
  </PropertyGroup>

  <Import Project="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).props" Condition="'$(TeronisMSBuildPackagingPackExecutablePropsHasBeenImported)' != 'true'"/>
  <Import Project="$(MSBuildThisFileDirectory)Teronis.MSBuild.Packaging.Pack.Common.targets" Condition="'$(TeronisMSBuildPackagingPackPackCommonTargetsHasBeenImported)' != 'true'" />

  <PropertyGroup Condition="'$(IsExecutablePackageTyped)' == 'true'">
    
    <!-- Mark as executable source project if target project is source project. -->
    <IsExecutableSourceTyped Condition="'$(PackageSourceIsSelfReferenced)' == 'true'">true</IsExecutableSourceTyped>
    <PackageId>$(PackageSourceProjectFilename)</PackageId>
    
    <!-- See Teronis.MSBuild.Packaging.Pack.Common.targets -->
    <!--<GenerateAssemblyInfo>false</GenerateAssemblyInfo>-->
    <!--<DisableImplicitFrameworkReferences>true</DisableImplicitFrameworkReferences>-->
    
    <GenerateNuspecWhenPackingExecutablePackageProjectDependsOn>$(BeforeGenerateNuspecWhenPackingExecutablePackageProject);IncludeExecutableSourceProjectPackageFiles;$(GenerateNuspecWhenPackingExecutablePackageProjectDependsOn)</GenerateNuspecWhenPackingExecutablePackageProjectDependsOn>
    <GenerateNuspecDependsOn>$(GenerateNuspecDependsOn);$(GenerateNuspecWhenPackingExecutablePackageProjectDependsOn)</GenerateNuspecDependsOn>
  
  </PropertyGroup>

  <!--<Target Name=""-->

  <Target Name="CollectExecutableSourceProjectPackageFiles" DependsOnTargets="$(GenerateNuspecDependsOn)" Condition="'$(IsExecutableSourceTyped)' == 'true'"
          Outputs="@(_ExecutablePackageFiles)">
    <ItemGroup>
      <_ExecutablePackageFiles Include="$([System.IO.Path]::GetFullPath('%(_PackageFiles.Identity)'))">
        <NuGetRecursiveDir>%(_PackageFiles.NuGetRecursiveDir)</NuGetRecursiveDir>
        <BuildAction>%(_PackageFiles.BuildAction)</BuildAction>
        <PackagePath>%(_PackageFiles.PackagePath)</PackagePath>
      </_ExecutablePackageFiles>
    </ItemGroup>
  </Target>

  <Target Name="TfmSpecificExecutablePackageProjectContentInPackage" Condition="'$(IsExecutablePackageTyped)' == 'true'" />

  <!--
  =====================================================
                          BuildExecutablePackageProject
  
  Includes package files from executable source
  project but only if executable project is not
  itself to prevent circular target dependency.
  =====================================================
   -->
  <Target Name="IncludeExecutableSourceProjectPackageFiles" DependsOnTargets="DefineLoadedPackageSourceAndPackagePackRelatedProperties"
          Condition="'$(IsExecutablePackageTyped)' == 'true' And !$(PackageSourceIsSelfReferenced)">

    <PropertyGroup>
      <_MSBuildProperties>
        PackSourceAs=$(InferredPackageSourceType)
      </_MSBuildProperties>
    </PropertyGroup>

    <MSBuild Projects="$(PackageSourceProjectFullPath)" Targets="CollectExecutableSourceProjectPackageFiles" Properties="$(_MSBuildProperties)">
      <Output TaskParameter="TargetOutputs" ItemName="_ExecutablePackageFiles"/>
    </MSBuild>

    <ItemGroup>
      <!-- Add executable project files to executable package project -->
      <_PackageFiles Include="@(_ExecutablePackageFiles)" />
    </ItemGroup>

  </Target>

  <!--
  =====================================================
     TfmSpecificExecutableSourceProjectContentInPackage
                                       
  This target is initially called by target
  TfmSpecificContentInPackage. This target includes the
  published files to the nuget package.
  =====================================================
  -->
  <Target Name="TfmSpecificExecutableSourceProjectContentInPackage" DependsOnTargets="PublishTfmSpecificExecutableAsProjectContent"
          Condition="'$(IsExecutableSourceTyped)' == 'true'">
    
    <PropertyGroup>
      <_PublishDir Condition="'$(IsExecutableSourceTyped)' == 'true'">$(MSBuildProjectDirectory)$(PublishDir)</_PublishDir>
    </PropertyGroup>

    <ItemGroup>

      <_PublishedFiles Include="$(_PublishDir)**\*" />

      <!--https://github.com/NuGet/NuGet.Client/blob/ad08bc710b3c4e142040f4efc860c003502aee3e/src/NuGet.Core/NuGet.Build.Tasks.Pack/NuGet.Build.Tasks.Pack.targets#L427-->
      <!--<NuGetRecursiveDir>%(_PublishedFiles.RecursiveDir)</NuGetRecursiveDir>-->
      <TfmSpecificPackageFileWithRecursiveDir Include="@(_PublishedFiles)">
        <PublishDir>$(_PublishDir)</PublishDir>
        <PackagePath>executables\$(TargetFramework)\%(_PublishedFiles.RecursiveDir)%(Filename)%(Extension)</PackagePath>
        <BuildAction></BuildAction>
      </TfmSpecificPackageFileWithRecursiveDir>

    </ItemGroup>

    <Message Text="- Filename: %(TfmSpecificPackageFileWithRecursiveDir.Filename)%(TfmSpecificPackageFileWithRecursiveDir.Extension) RecursiveDir: %(TfmSpecificPackageFileWithRecursiveDir.RecursiveDir)" Importance="normal" />

  </Target>

  <!--
  =====================================================
                  TfmSpecificExecutableContentInPackage
  
  This target publishes the MSBuild project to 
  $(PublishDir).
  =====================================================
  -->
  <Target Name="PublishTfmSpecificExecutableAsProjectContent" Condition="'$(IsExecutableSourceTyped)' == 'true'">

    <PropertyGroup>
      <_MSBuildProperties>
        PackSourceAs=$(InferredPackageSourceType);
        TargetFramework=$(TargetFramework)
      </_MSBuildProperties>
    </PropertyGroup>

    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="Publish" Properties="$(_MSBuildProperties)" />

  </Target>

  <!--<Target Name="_AfterGetTfmSpecificContentForPackage" BeforeTargets="_GetTfmSpecificContentForPackage" Condition="'$(IsExecutableSourceTyped)' == 'true'" />-->

  <Target Name="CleanExecutableSourceProject" BeforeTargets="Clean"
          Condition="'$(IsExecutableTargetTyped)' == 'true' And '$(PackageSourceIsSelfReferenced)' != 'true'">
    <MSBuild Projects="$(PackageSourceProjectFullPath)" Targets="Clean" />
  </Target>

  <Target Name="CleanNativePublishDir" DependsOnTargets="DefineLoadedPackageSourceProperties" BeforeTargets="Clean" Condition="'$(IsExecutablePackageTyped)' == 'true'">

    <ItemGroup>
      <_DeletablePublishFiles Include="$(ExecutableSourcePublishDir)\**\*" />
    </ItemGroup>

    <Delete Files="@(_DeletablePublishFiles)" />
    <RemoveDir Directories="$(ExecutableSourcePublishDir)" />

  </Target>

  <Target Name="_ApplyLoadedPropertiesToExecutablePackageProject" DependsOnTargets="DefineLoadedPackageSourceAndPackagePackRelatedProperties"
          BeforeTargets="GenerateNuspec;_GetProjectVersion"
          Condition="'$(IsExecutablePackageTyped)' == 'true'">

    <PropertyGroup>
      <PackageDescription Condition="'$(ExecutableSourceDiscription)' != ''">$(ExecutableSourceDiscription)</PackageDescription>
    </PropertyGroup>

    <PropertyGroup>
      <PackageVersion>$(ExecutableSourcePackageVersion)</PackageVersion>
    </PropertyGroup>

  </Target>

</Project>
